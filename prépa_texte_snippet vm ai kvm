langage: bash
nom: VM_AI_KVM_QEMU
titre: création d'un VM KVM-QEMU
description: étapes de création d'une virtual machine orienté intelligence artificielle
tags: vm,ia,virtuel,kvm,qemu,stockage,ubuntu





#Étape 1 : Vérifier l'environnement KVM existant
## bash ##

# Vérifier que KVM fonctionne bien
lsmod | grep kvm
virsh list --all

# Voir les ressources disponibles
virsh nodeinfo
free -h

## ##

#Étape 2 : Télécharger l'ISO Ubuntu
## bash ##

cd /var/lib/libvirt/images/
# ou votre répertoire d'images préféré

# Télécharger Ubuntu 24.04 LTS (Vérifier version en cours)
sudo wget https://releases.ubuntu.com/24.04/ubuntu-24.04-live-server-amd64.iso

## ##

#Étape 3 : Créer le disque virtuel
## bash ##

# Architecture recommandée :
# - Système VM + environnements Python : NVMe (rapide)
# - Datasets volumineux : WD Red en pool (capacité)
# - Modèles entraînés : WD Red en pool (sauvegarde)
#```

### Dimensionnement précis

#**150 GB c'est INSUFFISANT** pour l'IA. Voici pourquoi :
#```
#Breakdown typique :
#- Système Ubuntu : 10-15 GB
#- Environnements Python (venv) : 5-10 GB
#- Jupyter + notebooks : 2-5 GB
#- Cache pip/conda : 3-5 GB
#- Modèles pré-entraînés :
#  * LLaMA 7B : ~13 GB
#  * LLaMA 13B : ~26 GB
#  * Stable Diffusion XL : ~12 GB
#  * Mistral 7B : ~14 GB
#  * Whisper Large : ~3 GB
#- Datasets typiques :
#  * ImageNet subset : 20-50 GB
#  * Common Crawl sample : 10-100 GB
#  * Datasets personnalisés : Variable
#- Checkpoints d'entraînement : 10-50 GB par projet

## ##
# Recommandation : 300-500 GB minimum sur NVMe
# Configuration optimale
## bash ##

# SUR L'HÔTE DEBIAN (jarvis-kde)

# 1. Créer le disque système sur NVMe (performances)
sudo qemu-img create -f qcow2 /var/lib/libvirt/images/vm-ia-system.qcow2 300G

# 2. Créer un pool de stockage sur les WD Red pour les données
# Configuration d'un LVM ou ZFS sur les 3 disques

## ##

#Étape 4 : Créer la VM via virt-install
## bash ##

sudo virt-install \
  --name=vm-ia \
  --ram=32768 \
  --vcpus=12 \
  --cpu host-passthrough \
  --disk path=/var/lib/libvirt/images/vm-ia.qcow2,format=qcow2,bus=virtio \
  --cdrom=/var/lib/libvirt/images/ubuntu-24.04-live-server-amd64.iso \
  --network bridge=virbr0,model=virtio \
  --graphics vnc,listen=0.0.0.0,port=5904 \
  --os-variant=ubuntu24.04 \
  --virt-type=kvm \
  --boot uefi

## ##
# Explication des paramètres :
#   -ram=32768 : 32 GB de RAM (ajustable selon vos besoins)
#   -vcpus=12 : 12 threads CPU (laisse 20 threads pour l'hôte et autres VMs)
#   -cpu host-passthrough : Performances CPU maximales
#   -disk bus=virtio : Meilleure performance I/O
#   -network model=virtio : Meilleure performance réseau

#Étape 5 : Se connecter à la VM pour l'installation
## bash ##

# Via VNC depuis votre Debian
virt-viewer vm-ia

# Ou via VNC distant
# Utiliser un client VNC sur localhost:5904

## ##
# Procéder à l'installation Ubuntu standard.

#Étape 6 : Configuration post-installation
# Une fois Ubuntu installé et démarré :
## bash ##

# Se connecter en console
virsh console vm-ia

# Ou via SSH (après avoir configuré le réseau)

## ##
# Dans la VM Ubuntu :
## bash ##

# Mise à jour système
sudo apt update && sudo apt upgrade -y

# Installer les outils invité QEMU/KVM
sudo apt install -y qemu-guest-agent spice-vdagent

# Activer et démarrer l'agent
sudo systemctl enable qemu-guest-agent
sudo systemctl start qemu-guest-agent

# Redémarrer la VM
sudo reboot

## ##

#Étape 7 : Optimiser les performances KVM
# Sur votre Debian hôte :
## bash ##

# Éditer la configuration de la VM
sudo virsh edit vm-ia

## ##
# Ajouter ces optimisations dans le XML :
## xml ##

<domain type='kvm'>
  ...
  <cpu mode='host-passthrough' check='none'>
    <topology sockets='1' dies='1' cores='12' threads='1'/>
    <cache mode='passthrough'/>
    <feature policy='require' name='topoext'/>
  </cpu>

  <memoryBacking>
    <hugepages/>
  </memoryBacking>

  ...
</domain>

## ##
# Configurer les hugepages (optionnel mais recommandé) :
## bash ##

# Sur l'hôte Debian
sudo sh -c 'echo "vm.nr_hugepages = 16384" >> /etc/sysctl.conf'
sudo sysctl -p

# Vérifier
cat /proc/meminfo | grep Huge

## ##

#Étape 8 : Installer l'environnement IA dans la VM
## bash ##

# Dans la VM Ubuntu
sudo apt update

# Python et outils de développement
sudo apt install -y python3 python3-pip python3-venv build-essential git wget curl

# Créer environnement virtuel
python3 -m venv ~/ai-env
source ~/ai-env/bin/activate

# PyTorch (CPU optimisé)
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

# TensorFlow
pip install tensorflow

# Bibliothèques ML/DL essentielles
pip install numpy pandas matplotlib seaborn scikit-learn scipy
pip install jupyter jupyterlab notebook
pip install transformers datasets accelerate
pip install opencv-python pillow

# Outils de visualisation
pip install tensorboard wandb

# Framework pour LLMs
pip install langchain openai anthropic

## ##

#Étape 9 : Configuration réseau avancée
# Option A : Accès depuis votre réseau local (bridge)
## bash ##

# Sur l'hôte Debian, créer un bridge réseau
sudo virsh net-edit default

# Ou créer une nouvelle interface bridge
sudo virsh iface-bridge enp0s31f6 br0

## ##
# Option B : Port forwarding (plus simple)
## bash ##

# Rediriger le port Jupyter (8888) vers l'hôte
sudo virsh edit vm-ia

## ##
# Ajouter dans la section <devices> :
## xml ##

<qemu:commandline>
  <qemu:arg value='-netdev'/>
  <qemu:arg value='user,id=net0,hostfwd=tcp::8888-:8888'/>
</qemu:commandline>

## ##

#Étape 10 : Lancer Jupyter Lab
## bash ##

# Dans la VM
source ~/ai-env/bin/activate
jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root

## ##
# Accéder depuis votre Debian hôte : http://localhost:8888

#Étape 11 : Script de gestion pratique
# Créer /usr/local/bin/vm-ia-manage.sh sur votre hôte :
## bash ##

#!/bin/bash

case "$1" in
    start)
        virsh start vm-ia
        ;;
    stop)
        virsh shutdown vm-ia
        ;;
    console)
        virsh console vm-ia
        ;;
    snapshot)
        virsh snapshot-create-as vm-ia --name "snapshot-$(date +%Y%m%d-%H%M%S)"
        ;;
    info)
        virsh dominfo vm-ia
        virsh domstats vm-ia
        ;;
    *)
        echo "Usage: $0 {start|stop|console|snapshot|info}"
        exit 1
        ;;
esac

## ##
## bash ##

sudo chmod +x /usr/local/bin/vm-ia-manage.sh

## ##

#Étape 12 : Créer un snapshot initial
## bash ##

# Avant de commencer à travailler, créer un snapshot propre
virsh snapshot-create-as vm-ia --name "install-complete" --description "Installation de base terminée"

# Lister les snapshots
virsh snapshot-list vm-ia

# Restaurer si besoin
# virsh snapshot-revert vm-ia install-complete

## ##
# Configuration avancée : Ajout d'un GPU (si vous en avez un)
# Si vous avez une carte GPU NVIDIA dédiée à passer en PCIe passthrough :
## bash ##

# Identifier le GPU
lspci -nnk | grep -i nvidia

# Configuration IOMMU et passthrough
# (Configuration complexe, je peux détailler si vous avez un GPU dédié)

## ##
# Monitoring des ressources
## bash ##

# Sur l'hôte, surveiller la VM
watch -n 1 'virsh domstats vm-ia | grep -E "cpu|mem|disk|net"'

# Ou avec virt-top
sudo apt install virt-top
sudo virt-top

## ##
# Recommandations finales
# Répartition suggérée de vos ressources :
#   - VM IA : 12 vCPUs, 32 GB RAM
#   - Win11 : 4-6 vCPUs, 16 GB RAM
#   - Debian test : 2-4 vCPUs, 8 GB RAM
#   - Ubuntu Django : 4 vCPUs, 16 GB RAM
#   - Hôte réservé : 6-8 threads, 16-24 GB RAM
# Avec cette configuration, vous pouvez faire tourner simultanément toutes vos VMs confortablement.






















































