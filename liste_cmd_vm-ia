sudo virsh list --all

 ID   Nom           État
---------------------------
 -    debian13      fermé
 -    ubuntu22.04   fermé
 -    win11         fermé

virsh nodeinfo

modèle de CPU :    x86_64
CPU :               32
Fréquence de la CPU : 4877 MHz
socket(s) CPU :     1
Coeur(s) par emplacements : 16
Thread(s) par coeur : 2
cellule(s) NUMA :   1
Taille mémoire :   97957524 KiB

free -h
               total       utilisé      libre     partagé tamp/cache   disponible
Mem:            93Gi       4,5Gi        86Gi        93Mi       3,0Gi        88Gi
Échange:        16Gi          0B        16Gi

Étape 2 : Télécharger l'ISO Ubuntu
~/Téléchargements/ISO/ubuntu-22.04.5-live-server-amd64.iso

Étape 3 : Créer le disque virtuel
sudo qemu-img create -f qcow2 /var/lib/libvirt/images/vm-ia-system.qcow2 350G

Étape 4 : Créer la VM via virt-install

sudo virt-install \
  --name=vm-ia \
  --ram=32768 \
  --vcpus=12 \
  --cpu host-passthrough \
  --disk path=/var/lib/libvirt/images/vm-ia-system.qcow2,format=qcow2,bus=virtio \
  --cdrom=~/Téléchargements/ISO/ubuntu-22.04.5-live-server-amd64.iso \
  --network bridge=virbr0,model=virtio \
  --graphics vnc,listen=0.0.0.0,port=5904 \
  --os-variant=ubuntu24.04 \
  --virt-type=kvm \
  --boot uefi

# Explication des paramètres :

--ram=32768 : 32 GB de RAM (ajustable selon vos besoins)
--vcpus=12 : 12 threads CPU (laisse 20 threads pour l'hôte et autres VMs)
--cpu host-passthrough : Performances CPU maximales
--disk bus=virtio : Meilleure performance I/O
--network model=virtio : Meilleure performance réseau

# modifier nom du périphérique pour le reseau virbr0 -> br0
# connection
ssh laurent@192.168.1.198 -p 22

#Étape 6 : Configuration post-installation
#Une fois Ubuntu installé et démarré :

# Se connecter en console
virsh console vm-ia

# Ou via SSH (après avoir configuré le réseau)
ssh laurent@192.168.1.198 -p 22


# Mise à jour système
sudo apt update && sudo apt upgrade -y

# Installer les outils invité QEMU/KVM
sudo apt install -y qemu-guest-agent spice-vdagent

# Activer et démarrer l'agent
sudo systemctl enable qemu-guest-agent
sudo systemctl start qemu-guest-agent

# Redémarrer la VM
sudo reboot

# Étape 7 : Optimiser les performances KVM
# Sur votre Debian hôte :

# Éditer la configuration de la VM
sudo virsh edit vm-ia

# Ajouter ces optimisations dans le XML :
### xml ###

<domain type='kvm'>
  ...
  <cpu mode='host-passthrough' check='none'>
    <topology sockets='1' dies='1' cores='12' threads='1'/>
    <cache mode='passthrough'/>
    <feature policy='require' name='topoext'/>
  </cpu>
### ci-dessous attention peut planter au demarrage de la vm ####
  <memoryBacking>
    <hugepages/>
  </memoryBacking>

  ...
</domain>

### fin xml ###

# Configurer les hugepages (optionnel mais recommandé) :

# Sur l'hôte Debian
sudo sh -c 'echo "vm.nr_hugepages = 16384" >> /etc/sysctl.conf'
sudo sysctl -p
# vm.nr_hugepages = 16384

# Vérifier
cat /proc/meminfo | grep Huge
# AnonHugePages:   4530176 kB
# ShmemHugePages:        0 kB
# FileHugePages:         0 kB
# HugePages_Total:   16384
# HugePages_Free:    16384
# HugePages_Rsvd:        0
# HugePages_Surp:        0
# Hugepagesize:       2048 kB
# Hugetlb:        33554432 kB


Étape 8 : Installer l'environnement IA dans la VM

# Dans la VM Ubuntu
sudo apt update

# Python et outils de développement
sudo apt install -y python3 python3-pip python3-venv build-essential git wget curl

# Créer environnement virtuel
python3 -m venv ~/ai-env
source ~/ai-env/bin/activate

# PyTorch (CPU optimisé)
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

# TensorFlow
pip install tensorflow

# Bibliothèques ML/DL essentielles
pip install numpy pandas matplotlib seaborn scikit-learn scipy
pip install jupyter jupyterlab notebook
pip install transformers datasets accelerate
pip install opencv-python pillow

# Outils de visualisation
pip install tensorboard wandb

# Framework pour LLMs
pip install langchain openai anthropic

# Étape 9 : Configuration réseau avancée
# Option A : Accès depuis votre réseau local (bridge)

# Sur l'hôte Debian, créer un bridge réseau
#sudo virsh net-edit default

# Ou créer une nouvelle interface bridge
#sudo virsh iface-bridge enp0s31f6 br0

# Option B : Port forwarding (plus simple)

# Rediriger le port Jupyter (8888) vers l'hôte
#sudo virsh edit vm-ia

### ne fonctionne pas ###
# Ajouter dans la section <devices> :
#<qemu:commandline>
#  <qemu:arg value='-netdev'/>
#  <qemu:arg value='user,id=net0,hostfwd=tcp::8888-:8888'/>
#</qemu:commandline>
### ###

Étape 10 : Lancer Jupyter Lab

# Dans la VM
source ~/ai-env/bin/activate
jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root

Accéder depuis votre Debian hôte : http://localhost:8888
http://192.168.1.198:8888

Étape 11 : Script de gestion pratique
Créer /usr/local/bin/vm-ia-manage.sh sur votre hôte :

sudo nano /usr/local/bin/vm-ia-manage.sh
### nano ###
#!/bin/bash

case "$1" in
    start)
        virsh start vm-ia
        ;;
    stop)
        virsh shutdown vm-ia
        ;;
    console)
        virsh console vm-ia
        ;;
    snapshot)
        virsh snapshot-create-as vm-ia --name "snapshot-$(date +%Y%m%d-%H%M%S)"
        ;;
    info)
        virsh dominfo vm-ia
        virsh domstats vm-ia
        ;;
    *)
        echo "Usage: $0 {start|stop|console|snapshot|info}"
        exit 1
        ;;
esac

### fin nano ###

sudo chmod +x /usr/local/bin/vm-ia-manage.sh

Étape 12 : Créer un snapshot initial

# Avant de commencer à travailler, créer un snapshot propre
virsh snapshot-create-as vm-ia --name "install-complete" --description "Installation de base terminée"

# Lister les snapshots
virsh snapshot-list vm-ia

# Restaurer si besoin
# virsh snapshot-revert vm-ia install-complete









