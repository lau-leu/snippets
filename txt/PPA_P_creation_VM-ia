langage: bash
nom: VM_UBUNTU_AI_KVM_QEMU
titre: création d'un VM Ubuntu serveur KVM-QEMU orientée IA
description: étapes de création d'une virtual machine Ubuntu serveur orientée intelligence artificielle
tags: vm,ia,virtuel,kvm,qemu,stockage,ubuntu

# ===================================================================
ETAPE 1 : Vérifier l'environnement KVM existant
# ===================================================================
# Vérifier que KVM fonctionne bien
lsmod | grep kvm
# -->kvm_amd               217088  14
# -->kvm                  1396736  13 kvm_amd
# -->irqbypass              12288  1 kvm
# -->ccp                   163840  1 kvm_amd

sudo virsh list --all
# --> ID   Nom           État
# -->---------------------------
# --> -    debian13      fermé
# --> -    ubuntu22.04   fermé
# --> -    win11         fermé

virsh nodeinfo
# -->modèle de CPU :    x86_64
# -->CPU :               32
# -->Fréquence de la CPU : 4877 MHz
# -->socket(s) CPU :     1
# -->Coeur(s) par emplacements : 16
# -->Thread(s) par coeur : 2
# -->cellule(s) NUMA :   1
# -->Taille mémoire :   97957524 KiB

free -h
# -->               total       utilisé      libre     partagé tamp/cache   disponible
# -->Mem:            93Gi       4,5Gi        86Gi        93Mi       3,0Gi        88Gi
# -->Échange:        16Gi          0B        16Gi

# ===================================================================
# ETAPE 2 : Télécharger l'ISO Ubuntu
# ===================================================================
# Emplacement de l'ISO
cd /var/lib/libvirt/images/
# ou votre répertoire d'images préféré
cd ~/Téléchargements/ISO/

# Télécharger Ubuntu 24.04 LTS
sudo wget https://releases.ubuntu.com/24.04/ubuntu-22.04.5-live-server-amd64.iso

# ===================================================================
# ETAPE 3 : Créer le disque virtuel
# ===================================================================
sudo qemu-img create -f qcow2 /var/lib/libvirt/images/vm-ia-system.qcow2 350G

# pour test de l'IA recommandation : 300-500 GB minimum sur NVMe
#Breakdown typique :
#- Système Ubuntu : 10-15 GB
#- Environnements Python (venv) : 5-10 GB
#- Jupyter + notebooks : 2-5 GB
#- Cache pip/conda : 3-5 GB
#- Modèles pré-entraînés :
#  * LLaMA 7B : ~13 GB
#  * LLaMA 13B : ~26 GB
#  * Stable Diffusion XL : ~12 GB
#  * Mistral 7B : ~14 GB
#  * Whisper Large : ~3 GB
#- Datasets typiques :
#  * ImageNet subset : 20-50 GB
#  * Common Crawl sample : 10-100 GB
#  * Datasets personnalisés : Variable
#- Checkpoints d'entraînement : 10-50 GB par projet

# ===================================================================
# ETAPE 4 : Créer la VM via virt-install
# ===================================================================
sudo virt-install \
  --name=vm-ia \
  --ram=32768 \
  --vcpus=12 \
  --cpu host-passthrough \
  --disk path=/var/lib/libvirt/images/vm-ia-system.qcow2,format=qcow2,bus=virtio \
  --cdrom=~/Téléchargements/ISO/ubuntu-22.04.5-live-server-amd64.iso \
  --network bridge=virbr0,model=virtio \
  --graphics vnc,listen=0.0.0.0,port=5904 \
  --os-variant=ubuntu24.04 \
  --virt-type=kvm \
  --boot uefi

# Explication des paramètres :

--ram=32768 : 32 GB de RAM (ajustable selon vos besoins)
--vcpus=12 : 12 threads CPU (laisse 20 threads pour l'hôte et autres VMs)
--cpu host-passthrough : Performances CPU maximales
--disk bus=virtio : Meilleure performance I/O
--network model=virtio : Meilleure performance réseau

# ===================================================================
# ETAPE 5 : Se connecter à la VM pour l'installation
# ===================================================================
# Via VNC depuis votre Debian
virt-viewer vm-ia
# Ou via VNC distant
# Utiliser un client VNC sur localhost:5904
# Ou virt-manger directement

# Une fois dans l'interface d'installation :

# 1.Langue : Français
# 2.Clavier : Français
# 3.Type d'installation : Ubuntu Server
# 4.Configuration réseau : Accepter DHCP par défaut
# 5.Proxy : Laisser vide
# 6.Miroir : Garder par défaut
# 7.Disque :
#  - Utiliser le disque entier
#  - Partition automatique (LVM recommandé)
# 8.Profil :
#  - Nom : laurent (ou votre choix)
#  - Serveur : vm-ia
#  - Username : laurent
#  - Mot de passe : [votre choix]
# 9.SSH : Installer OpenSSH server ✓
# 10.Snaps : Ne rien sélectionner (on installera manuellement)
# 11.Installation : Attendre la fin (~10-15 min)
# 12.Reboot : Retirer le CD virtuel et redémarrer

# ===================================================================
# ETAPE 6 : Configuration post-installation
# ===================================================================
#Une fois Ubuntu installé et démarré :
# Se connecter en console
virsh console vm-ia

# Ou via SSH (après avoir configuré le réseau)
# modifier nom du périphérique pour le reseau virbr0 -> br0
# récupérer l'IP
ssh laurent@192.168.1.198 -p 22

# Mise à jour système
sudo apt update && sudo apt upgrade -y

# Installer les outils invité QEMU/KVM
sudo apt install -y qemu-guest-agent spice-vdagent

# Activer et démarrer l'agent
sudo systemctl enable qemu-guest-agent
sudo systemctl start qemu-guest-agent

# Redémarrer la VM
sudo reboot

# ===================================================================
# ETAPE 7 : Optimiser les performances KVM
# ===================================================================
# Sur votre Debian hôte :
# Éditer la configuration de la VM
sudo virsh edit vm-ia

# Ajouter ces optimisations dans le XML :
### xml ###

<domain type='kvm'>
  ...
  <cpu mode='host-passthrough' check='none'>
    <topology sockets='1' dies='1' cores='12' threads='1'/>
    <cache mode='passthrough'/>
    <feature policy='require' name='topoext'/>
  </cpu>
### ci-dessous attention peut planter au demarrage de la vm ####
  <memoryBacking>
    <hugepages/>
  </memoryBacking>

  ...
</domain>

### fin xml ###

# Configurer les hugepages (optionnel mais recommandé) :

# Sur l'hôte Debian
sudo sh -c 'echo "vm.nr_hugepages = 16384" >> /etc/sysctl.conf'
sudo sysctl -p
# vm.nr_hugepages = 16384

# Vérifier
cat /proc/meminfo | grep Huge
# AnonHugePages:   4530176 kB
# ShmemHugePages:        0 kB
# FileHugePages:         0 kB
# HugePages_Total:   16384
# HugePages_Free:    16384
# HugePages_Rsvd:        0
# HugePages_Surp:        0
# Hugepagesize:       2048 kB
# Hugetlb:        33554432 kB

# ===================================================================
# ETAPE 8 : Installer l'environnement IA dans la VM
# ===================================================================
# Mettre à jour le système
sudo apt update && sudo apt upgrade -y

# Installer les outils essentiels
sudo apt install -y build-essential git wget curl vim

# Installer Python et pip
sudo apt install -y python3 python3-pip python3-venv

# Installer les drivers NVIDIA (si GPU)
#sudo apt install -y nvidia-driver-535
#sudo reboot

#Installer les frameworks d'IA
# Créer environnement virtuel
python3 -m venv ~/ai-env
source ~/ai-env/bin/activate

# PyTorch (CPU optimisé)
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

# TensorFlow
pip install tensorflow
#ou voir différence
#pip install tensorflow[and-cuda]

# Bibliothèques ML/DL essentielles
pip install numpy pandas matplotlib seaborn scikit-learn scipy
pip install jupyter jupyterlab notebook
pip install transformers datasets accelerate
pip install opencv-python pillow

# Outils de visualisation
pip install tensorboard wandb

# Framework pour LLMs
pip install langchain openai anthropic

# ===================================================================
# ETAPE 9 : Configuration réseau avancée
# ===================================================================
# Option A : Accès depuis votre réseau local (bridge)

# Sur l'hôte Debian, créer un bridge réseau
#sudo virsh net-edit default

# Ou créer une nouvelle interface bridge
#sudo virsh iface-bridge enp0s31f6 br0

# Option B : Port forwarding (plus simple)

# Rediriger le port Jupyter (8888) vers l'hôte
#sudo virsh edit vm-ia

### ne fonctionne pas ###
# Ajouter dans la section <devices> :
#<qemu:commandline>
#  <qemu:arg value='-netdev'/>
#  <qemu:arg value='user,id=net0,hostfwd=tcp::8888-:8888'/>
#</qemu:commandline>
### ###

# ===================================================================
# ETAPE 10 : Lancer Jupyter Lab
# ===================================================================
# Dans la VM
source ~/ai-env/bin/activate
jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root
# Noter le token d'accès affiché

Accéder depuis votre Debian hôte : http://localhost:8888
http://192.168.1.198:8888

# ===================================================================
# ETAPE 11 : Script et outils de gestion pratique
# ===================================================================
Créer /usr/local/bin/vm-ia-manage.sh sur votre hôte :

sudo nano /usr/local/bin/vm-ia-manage.sh
### nano ###
#!/bin/bash

case "$1" in
    start)
        virsh start vm-ia
        ;;
    stop)
        virsh shutdown vm-ia
        ;;
    console)
        virsh console vm-ia
        ;;
    snapshot)
        virsh snapshot-create-as vm-ia --name "snapshot-$(date +%Y%m%d-%H%M%S)"
        ;;
    info)
        virsh dominfo vm-ia
        virsh domstats vm-ia
        ;;
    *)
        echo "Usage: $0 {start|stop|console|snapshot|info}"
        exit 1
        ;;
esac

### fin nano ###

sudo chmod +x /usr/local/bin/vm-ia-manage.sh

# Monitoring des ressources
# Sur l'hôte, surveiller la VM
watch -n 1 'virsh domstats vm-ia | grep -E "cpu|mem|disk|net"'

# Ou avec virt-top
sudo apt install virt-top
sudo virt-top

# Configuration avancée : Ajout d'un GPU (si vous en avez un)
# Si vous avez une carte GPU NVIDIA dédiée à passer en PCIe passthrough :
# Identifier le GPU
lspci -nnk | grep -i nvidia

# Configuration IOMMU et passthrough
# (Configuration complexe, je peux détailler si vous avez un GPU dédié)

# ===================================================================
# ETAPE 12 : Créer un snapshot initial
# ===================================================================
# Avant de commencer à travailler, créer un snapshot propre
virsh snapshot-create-as vm-ia --name "install-complete" --description "Installation de base terminée"

# Lister les snapshots
virsh snapshot-list vm-ia

# Restaurer si besoin
# virsh snapshot-revert vm-ia install-complete

# Snapshot (mot clé d'aide 'snapshot')
#     snapshot-create                Créer un instantané depuis le XML
#     snapshot-create-as             Créer un instantané depuis un ensemble d’args
#     snapshot-current               Obtenir ou définir l'instantané actuel
#     snapshot-delete                Supprimer un instantané de domaine
#     snapshot-dumpxml               Dump XML pour un instantané de domaine
#     snapshot-edit                  modifier le XML pour un instantané
#     snapshot-info                  informations instantanées
#     snapshot-list                  Liste des instantanés pour un domaine
#     snapshot-parent                Obtenir le nom du parent d'un instantané
#     snapshot-revert                Renvoie un domaine à un instantané

# ===================================================================
# ETAPE 13 : Vérifier l'installation
# ===================================================================
# Créer un fichier test test_gpu.py :
## python ##

import torch
import tensorflow as tf

print(f"PyTorch version: {torch.__version__}")
print(f"CUDA available: {torch.cuda.is_available()}")
if torch.cuda.is_available():
    print(f"GPU: {torch.cuda.get_device_name(0)}")

print(f"\nTensorFlow version: {tf.__version__}")
print(f"TF GPU available: {len(tf.config.list_physical_devices('GPU'))} GPU(s)")

## ##

# ===================================================================
# ETAPE 14 : Outils optionnels mais utiles
# ===================================================================
## bash ##

# Docker pour conteneuriser vos projets
sudo apt install -y docker.io
sudo usermod -aG docker $USER

# Git LFS pour les gros fichiers de modèles
sudo apt install -y git-lfs
git lfs install

# VS Code Server pour développer à distance
wget -O- https://aka.ms/install-vscode-server/setup.sh | sh

## ##

# ===================================================================
# Prochaines étapes selon votre projet :
# ===================================================================
#   -Computer Vision : OpenCV, YOLO, Detectron2
#   -NLP : Hugging Face Transformers, spaCy
#   -Reinforcement Learning : Stable-Baselines3, Gymnasium




